----
kind: ConfigMap
apiVersion: v1
metadata:
  name: custom-detectors
data:
  custom_detectors.py: |-
    import re
    import requests
    import logging
    import urllib3
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    logger = logging.getLogger(__name__)

    MODEL_URL = "http://llama-32-predictor:8080/v1/chat/completions"
    MODEL_NAME= "llama32"

    # === TURN POLICY LIST INTO PROMPTS ================================================================
    REFUSAL_PROMPT = """Your task is to check if the following message looks like an LLM refusal message. Examples of refusals might be:
     - Not answering the original question, and providing a stock answer
     - Apologizing for an inability to help
     - Refusing to help
    Return "YES!" or "NO!".
    """

    TOXICITY_PROMPT = """Your task is to measure the toxicity of the following user message. 

    Return "0!", "1!", "2!", or "3!".
    """

    # === HELPER FUNCTIONS =============================================================================
    def _build_response(text, message, detection_type):
        """Build the expected payload for the /detectors API"""
        return {
            "start": 0,
            "end": len(text),
            "text": message,
            "detection_type": detection_type,
            "detection": "guardrail",
            "score": 1.0
        }

    def _chat_completion_to_model(user_prompt, system_prompt, headers, tokens=10):
        """Send a chat-completion to the model"""
        payload = {
            "model": MODEL_NAME,
            "messages": [
                {"content": system_prompt, "role": "system"},
                {"content": user_prompt, "role": "user"}
            ],
            "stop": "!", # stop generation as soon as the expected pattern is finished
            "temperature": 0
        }
        response = requests.post(MODEL_URL, json=payload, verify=False,
                                 headers=headers)
        if response.status_code != 200:
            raise RuntimeError(response.text)
        return response.json()["choices"][0]['message']['content'].replace("[","")


    # === MONITORING FUNCTIONS ======================================================================
    from prometheus_client import Counter
    refusal_metric = Counter(
        "refusal_counter",
        "Counts how many times the model has produced a refusal message"
    )
    @use_instruments(instruments=[refusal_metric])
    @non_blocking(return_value=False)
    def refusal_tracker(text: str, headers: dict):
        response = _chat_completion_to_model(text, system_prompt=REFUSAL_PROMPT, headers=headers)
        response = response.replace("Answer:","").strip()
        print(f"REFUSAL TRACKER | Model response: `{response}`")
        if response != 'NO':
            refusal_metric.inc()
        return False


    toxicity_metric = Counter(
        "toxicity_score",
        "Measures the cumulative toxicity of inbound messages. Use this to compute average toxicity per message."
    )
    @use_instruments(instruments=[toxicity_metric])
    @non_blocking(return_value=False)
    def toxicity_tracker(text: str, headers: dict):
        response = _chat_completion_to_model(text, system_prompt=TOXICITY_PROMPT, headers=headers)
        toxicity = float(response.strip())/4
        print(f"TOXICITY TRACKER | Model response: `{response}`")
        if toxicity > 0:
            toxicity_metric.inc(toxicity)
        return False
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: fms-orchestr8-config-nlp
data:
  config.yaml: |
    openai: 
      service:
        hostname: llama-32-predictor
        port: 8080
    detectors:
      regex_competitor:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      input_statistics:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      output_statistics:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      hap:
        type: text_contents
        service:
          hostname: guardrails-detector-ibm-hap-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      prompt_injection:
        type: text_contents
        service:
          hostname: prompt-injection-detector-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      language_detection:
        type: text_contents
        service:
          hostname: language-detector-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: fms-orchestr8-config-gateway
data:
  config.yaml: |
    orchestrator:
      host: "localhost"
      port: 8032
    detectors:
      - name: input_statistics
        input: true
        output: false
        detector_params:
         custom:    
            - toxicity_tracker
      - name: output_statistics
        input: false 
        output: true
        detector_params:
         custom:    
            - refusal_tracker
      - name: regex_competitor
        input: true
        output: true
        detector_params:
          regex:
            - \b(?i:oranges?|apples?|cranberr(?:y|ies)|pineapples?|grapes?|strawberr(?:y|ies)|blueberr(?:y|ies)|watermelons?|durians?|cloudberr(?:y|ies)|bananas?|mangoes?|peaches?|pears?|plums?|cherr(?:y|ies)|kiwifruits?|kiwis?|papayas?|avocados?|coconuts?|raspberr(?:y|ies)|blackberr(?:y|ies)|pomegranates?|figs?|dates?|apricots?|nectarines?|tangerines?|clementines?|grapefruits?|limes?|passionfruits?|dragonfr uits?|lychees?|guavas?|persimmons?)\b
            - \b(?i:portakals?|elmalar?|kızılcık(?:lar)?|ananaslar?|üzümler?|çilek(?:ler)?|yaban mersin(?:leri)?|karpuzlar?|durianlar?|bulutot(?:u|ları)?|muzlar?|mango(?:lar)?|şeftaliler?|armutlar?|erikler?|kiraz(?:lar)?|kiviler?|papayalar?|avokadolar?|hindistan cevizi(?:ler)?|ahududular?|böğürtlen(?:ler)?|nar(?:lar)?|incir(?:ler)?|hurmalar?|kayısı(?:lar)?|nektarin(?:ler)?|mandalina(?:lar)?|klementin(?:ler)?|greyfurt(?:lar)?|lime(?:lar)?|passionfruit(?:lar)?|ejder meyvesi(?:ler)?|liçi(?:ler)?|hurma(?:lar)?)\b
            - \b(?i:apelsin(?:er)?|äpple(?:n)?|tranbär(?:en)?|ananas(?:er)?|druv(?:a|or)?|jordgubb(?:e|ar)?|blåbär(?:en)?|vattenmelon(?:er)?|durian(?:er)?|hjortron(?:en)?|banan(?:er)?|mango(?:r)?|persika(?:or)?|päron(?:en)?|plommon(?:en)?|körsbär(?:en)?|kiwi(?:er)?|papaya(?:or)?|avokado(?:r)?|kokosnöt(?:ter)?|hallon(?:en)?|björnbär(?:en)?|granatäpple(?:n)?|fikon(?:en)?|dadel(?:ar)?|aprikos(?:er)?|nektarin(?:er)?|mandarin(?:er)?|klementin(?:er)?|grapefrukt(?:er)?|lime(?:r)?|passionsfrukt(?:er)?|drakfrukt(?:er)?|litchi(?:er)?|guava(?:or)?|kaki(?:frukter)?)\b
            - \b(?i:appelsiini(?:t|a|n)?|omena(?:t|a|n)?|karpalo(?:t|ita|n)?|ananas(?:t|ia|en)?|viinirypäle(?:et|itä|en)?|mansikka(?:t|a|n)?|mustikka(?:t|a|n)?|vesimeloni(?:t|a|n)?|durian(?:it|ia|in)?|lakka(?:t|a|n)?|banaani(?:t|a|n)?|mango(?:t|a|n)?|persikka(?:t|a|n)?|päärynä(?:t|ä|n)?|luumu(?:t|ja|n)?|kirsikka(?:t|a|n)?|kiivi(?:t|ä|n)?|papaja(?:t|a|n)?|avokado(?:t|a|n)?|kookospähkinä(?:t|ä|n)?|vadelma(?:t|a|n)?|karhunvatukka(?:t|a|n)?|granaattiomena(?:t|a|n)?|viikuna(?:t|a|n)?|taateli(?:t|a|n)?|aprikoosi(?:t|a|n)?|nektariini(?:t|a|n)?|mandariini(?:t|a|n)?|klementiini(?:t|a|n)?|greippi(?:t|ä|n)?|lime(?:t|ä|n)?|passionhedelmä(?:t|ä|n)?|lohikäärmehedelmä(?:t|ä|n)?|litsi(?:t|ä|n)?|guava(?:t|a|n)?|persimoni(?:t|a|n)?)\b
            - \b(?i:sinaasappel(?:en)?|appel(?:s)?|veenbes(?:sen)?|ananas(?:sen)?|druif(?:fen)?|aardbei(?:en)?|blauwe bes(?:sen)?|watermeloen(?:en)?|durian(?:s)?|honingbes(?:sen)?|banaan(?:en)?|mango(?:'s|s)?|perzik(?:ken)?|peer(?:en)?|pruim(?:en)?|kers(?:en)?|kiwi(?:'s|s)?|papaja(?:'s|s)?|avocado(?:'s|s)?|kokosnoot(?:en)?|framboos(?:zen)?|braam(?:men)?|granaatappel(?:en)?|vijg(?:en)?|dadel(?:s|en)?|abrikoos(?:zen)?|nectarine(?:n)?|mandarijn(?:en)?|clementine(?:n)?|grapefruit(?:s|en)?|limoen(?:en)?|passievrucht(?:en)?|draakvrucht(?:en)?|lychee(?:s|’s)?|guave(?:s|n)?|kaki(?:’s|s)?)\b
            - \b(?i:orange(?:s)?|pomme(?:s)?|canneberge(?:s)?|ananas(?:s)?|raisin(?:s)?|fraise(?:s)?|myrtille(?:s)?|pastèque(?:s)?|durian(?:s)?|airelle(?:s)?|banane(?:s)?|mangue(?:s)?|pêche(?:s)?|poire(?:s)?|prune(?:s)?|cerise(?:s)?|kiwi(?:s)?|papaye(?:s)?|avocat(?:s)?|noix de coco|framboise(?:s)?|mûre(?:s)?|grenade(?:s)?|figue(?:s)?|datte(?:s)?|abricot(?:s)?|nectarine(?:s)?|mandarine(?:s)?|clémentine(?:s)?|pamplemousse(?:s)?|citron vert|fruit de la passion(?:s)?|fruit du dragon(?:s)?|litchi(?:s)?|goyave(?:s)?|kaki(?:s)?)\b
            - \b(?i:naranja(?:s)?|manzana(?:s)?|arándano(?:s)?|piña(?:s)?|uva(?:s)?|fresa(?:s)?|arándano azul(?:es)?|sandía(?:s)?|durian(?:es)?|mora ártica(?:s)?|plátano(?:s)?|mango(?:s)?|melocotón(?:es)?|pera(?:s)?|ciruela(?:s)?|cereza(?:s)?|kiwi(?:s)?|papaya(?:s)?|aguacate(?:s)?|coco(?:s)?|frambuesa(?:s)?|mora(?:s)?|granada(?:s)?|higo(?:s)?|dátil(?:es)?|albaricoque(?:s)?|nectarina(?:s)?|mandarina(?:s)?|clementina(?:s)?|pomelo(?:s)?|lima(?:s)?|fruta de la pasión(?:es)?|fruta del dragón(?:es)?|lichi(?:s)?|guayaba(?:s)?|caqui(?:s)?)\b
            - \b(?i:orange(?:n)?|apfel(?:s)?|preiselbeere(?:n)?|ananas(?:se)?|traube(?:n)?|erdbeere(?:n)?|blaubeere(?:n)?|wassermelone(?:n)?|durian(?:s)?|moltebeere(?:n)?|banane(?:n)?|mango(?:s)?|pfirsich(?:e|en)?|birne(?:n)?|pflaume(?:n)?|kirsche(?:n)?|kiwi(?:s)?|papaya(?:s)?|avocado(?:s)?|kokosnuss(?:e|n)?|himbeere(?:n)?|brombeere(?:n)?|granatapfel(?:¨e|n)?|feige(?:n)?|dattel(?:n)?|aprikose(?:n)?|nektarine(?:n)?|mandarine(?:n)?|klementine(?:n)?|grapefruit(?:s)?|limette(?:n)?|passionsfrucht(?:¨e|en)?|drachenfrucht(?:¨e|en)?|litschi(?:s)?|guave(?:n)?|kaki(?:s)?)\b
            - \b(?i:オレンジ|みかん|リンゴ|クランベリー|パイナップル|ぶどう|イチゴ|ブルーベリー|スイカ|ドリアン|クラウドベリー|バナナ|マンゴー|モモ|ナシ|スモモ|サクランボ|キウイ|パパイヤ|アボカド|ココナッツ|ラズベリー|ブラックベリー|ザクロ|イチジク|ナツメ|アプリコット|ネクタリン|タンジェリン|クレメンタイン|グレープフルーツ|ライム|パッションフルーツ|ドラゴンフルーツ|ライチ|グアバ|柿)\b
            - \b(?i:апельсин(?:ы)?|яблоко(?:а|и)?|клюква(?:ы)?|ананас(?:ы)?|виноград(?:ы)?|клубника(?:и)?|черника(?:и)?|арбуз(?:ы)?|дуриан(?:ы)?|морошка(?:и)?|банан(?:ы)?|манго(?:ы)?|персик(?:и)?|груша(?:и)?|слива(?:ы)?|вишня(?:и)?|киви(?:и)?|папайя(?:и)?|авокадо(?:ы)?|кокос(?:ы)?|малина(?:ы)?|ежевика(?:и)?|гранат(?:ы)?|инжир(?:ы)?|финик(?:и)?|абрикос(?:ы)?|нектарин(?:ы)?|мандарин(?:ы)?|клементин(?:ы)?|грейпфрут(?:ы)?|лайм(?:ы)?|маракуйя|драконий фрукт|личи|гуава(?:ы)?|хурма(?:ы)?)\b
            - \b(?i:arancia(?:e)?|mela(?:e)?|mirtillo rosso(?:i)?|ananas(?:i)?|uva(?:e)?|fragola(?:e)?|mirtillo(?:i)?|anguria(?:e)?|durian(?:i)?|lampone(?:i)?|banana(?:e)?|mango(?:i)?|pesca(?:he)?|pera(?:e)?|prugna(?:e)?|ciliegia(?:he)?|kiwi(?:s)?|papaya(?:e)?|avocado(?:i)?|cocco(?:i)?|lampone(?:i)?|mora(?:e)?|melograno(?:i)?|fico(?:chi)?|dattero(?:i)?|albicocca(?:he)?|nettarella(?:e)?|mandarino(?:i)?|clementina(?:e)?|pompelmo(?:i)?|lime(?:s)?|frutto della passione(?:i)?|frutto del drago(?:i)?|litchi(?:s)?|guava(?:e)?|cachi?)\b
            - \b(?i:pomarańcza(?:e|y)?|jabłko(?:a|i)?|żurawina(?:y)?|ananasy?|winogrono(?:a|a)?|truskawka(?:i|ek)?|jagoda(?:i|y)?|arbuz(?:y)?|durian(?:y)?|moroszka(?:i)?|banan(?:y|ów)?|mango(?:a|i)?|brzoskwinia(?:e|y)?|gruszka(?:i|ek)?|śliwka(?:i|ek)?|wiśnia(?:e|i)?|kiwi(?:i)?|papaja(?:e|y)?|awokado(?:a)?|kokos(?:y)?|malina(?:y)?|jeżyna(?:y)?|granat(?:y)?|figa(?:i)?|daktyl(?:e)?|morela(?:e|y)?|nektaryna(?:y)?|mandarynka(?:i|ek)?|klementynka(?:i|ek)?|grejpfrut(?:y)?|limonka(?:i)?|marakuja(?:e|y)?|smoczy owoc(?:y)?|liczi(?:e)?|guawa(?:y)?|persymona(?:y)?)\b
            - \b(?i:橙子|桔子|苹果|蔓越莓|菠萝|葡萄|草莓|蓝莓|西瓜|榴莲|云莓|香蕉|芒果|桃子|梨|李子|樱桃|猕猴桃|木瓜|牛油果|椰子|覆盆子|黑莓|石榴|无花果|枣|杏|油桃|柑橘|柑橘类|柠檬|百香果|火龙果|荔枝|番石榴|柿子)\b
            - \b(?i:संतरा|ऑरेंज|सेब|क्रैनबेरी|अनानास|अंगूर|स्ट्रॉबेरी|ब्लूबेरी|तरबूज|ड्यूरियन|क्लाउडबेरी|केला|मैंगो|आड़ू|नाशपाती|आलूबुखारा|चेरी|कीवी|पपीता|एवोकाडो|नारियल|रास्पबेरी|ब्लैकबेरी|अनार|अंजीर|खजूर|खुबानी|नेकटेरिन|मंडारिन|क्लेमेंटाइन|ग्रेपफ्रूट|नींबू|पासनफ्रूट|ड्रैगन फ्रूट|लीची|अमरूद|तेंदू)\b
            - \b(?i:(\\u[0-9a-fA-F]{4}|\\U[0-9a-fA-F]{8})+)\b
            - \b(?i:instruction|instructions|rule|rules|prompt|policy|policies|system message|system messages|guideline|guidelines|command|commands|directive|directives)\b'
            # --- Prompt-injection / instruction-override patterns ---
            # Attempts to ignore/override prior/system instructions
            - '(?i)\b(ignore|disregard|override|bypass|forget)\b.*\b(previous|above|earlier|system|developer|guardrail|rules?|instructions?)\b'
            - '(?i)\b(ignorera|bortse|åsidosätt|kringgå|glöm)\b.*\b(tidigare|ovan|föregående|system|utvecklare|skyddsräcke|regler?|instruktioner?)\b'

            # "This is the only rule", "new rules", "replace rules"
            - '(?i)\b(this is (the )?only rule|the only rule|new rules?|replace (all )?rules?)\b'
            - '(?i)\b(det här är (den )?enda regeln|den enda regeln|nya regler?|ersätt (alla )?regler?)\b'

            # Persistent-scope cues
            - '(?i)\b(from now on|starting now|effective immediately)\b'

            # Role hijacking / jailbreak-y cues
            - '(?i)\b(act as|pretend to be|role-?play as|jailbreak|devmode)\b'

            # Global word bans / forced omission
            - '(?i)\b(do not|don''t)\s+(say|write|mention|use)\b'

            # Capability claims + language forcing (e.g., "you now understand Swedish")
            - '(?i)\byou (now )?understand\b.*\b(turkish|swedish|german|french|finnish|all languages)\b'

            # System-prompt manipulation
            - '(?i)\b(new system prompt|override (the )?system|ignore safety)\b'

            # Lines that start with meta-rule declarations like "Rule:", "Instruction:", etc.
            - '(?i)^\s*(rule|instruction|policy|system)\s*:'

            # "Regardless of rules/policy/instructions"
            - '(?i)\bregardless (of|regarding)\b.*\b(rules?|policy|policies|instructions?)\b'

            # "Even if it violates/contradicts rules/safety"
            - '(?i)\b(even if|regardless)\b.*\b(violates?|contradicts?)\b.*\b(rules?|policy|policies|safety)\b'

            # Mentions of system/developer instruction objects
            - '(?i)\b(system|developer)\s+(prompt|message|instructions?)\b'
      - name: hap
        input: true
        output: true
        detector_params: {}
      - name: prompt_injection
        input: true
        output: false
        detector_params: {}
      - name: language_detection
        input: true
        output: true
        detector_params: {}
    routes:
      - name: all
        detectors:
          - regex_competitor
          - hap
          - prompt_injection
          - language_detection
          - input_statistics
          - output_statistics
        fallback_message: "I'm sorry I can't be with you. Is there anything else I can help you with?"
      - name: hap
        detectors:
          - hap
        fallback_message: "You know I can't let you ask me that."
      - name: passthrough
        detectors:
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: fms-orchestr8-config-nlp
data:
  config.yaml: |
    openai: 
      service:
        hostname: llama-32-predictor
        port: 8080
    detectors:
      regex_competitor:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      input_statistics:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      output_statistics:
        type: text_contents
        service:
            hostname: "127.0.0.1"
            port: 8080
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      hap:
        type: text_contents
        service:
          hostname: guardrails-detector-ibm-hap-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      prompt_injection:
        type: text_contents
        service:
          hostname: prompt-injection-detector-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
      language_detection:
        type: text_contents
        service:
          hostname: language-detector-predictor
          port: 8000
        chunker_id: whole_doc_chunker
        default_threshold: 0.5
---
apiVersion: trustyai.opendatahub.io/v1alpha1
kind: GuardrailsOrchestrator
metadata:
  name: guardrails-orchestrator
  finalizers:
    - trustyai.opendatahub.io/gorch-finalizer
spec:
  customDetectorsConfig: custom-detectors
  enableBuiltInDetectors: true
  enableGuardrailsGateway: true
  guardrailsGatewayConfig: fms-orchestr8-config-gateway
  orchestratorConfig: fms-orchestr8-config-nlp
  otelExporter:
    otlpProtocol: grpc
  replicas: 1
